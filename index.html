<script>
  // ===== 版本號：用來顯示「網站已更新」的小提示 =====
  const APP_VERSION = "0.5.0";

  // ===== 左側選單：切換頁面 =====
  const navButtons = document.querySelectorAll(".nav-btn");
  const pages = document.querySelectorAll(".page");
  const sidebarNav = document.getElementById("sidebarNav");
  const mobileToggle = document.querySelector(".mobile-menu-toggle");
  let currentPageId = "page-play";

  function showPage(pageId) {
    currentPageId = pageId;
    pages.forEach((p) => {
      p.classList.toggle("active", p.id === pageId);
    });
    navButtons.forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.page === pageId);
    });
    // 手機版切換頁面後，自動收起選單
    if (window.innerWidth <= 900) {
      sidebarNav.classList.remove("open");
    }
    logDebug("切換頁面：" + pageId);
  }

  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.page;
      showPage(target);
    });
  });

  if (mobileToggle) {
    mobileToggle.addEventListener("click", () => {
      sidebarNav.classList.toggle("open");
    });
  }

  // ===== 設定 / Debug 面板 =====
  const btnSettings = document.getElementById("btnSettings");
  const settingsPanel = document.getElementById("settingsPanel");
  const chkDebug = document.getElementById("chkDebug");
  const debugPanel = document.getElementById("debugPanel");
  const debugBody = document.getElementById("debugBody");
  const btnDebugClear = document.getElementById("btnDebugClear");

  // Debug 開關狀態從 localStorage 還原
  const DEBUG_KEY = "tongue_drum_app_debug";
  const savedDebug = localStorage.getItem(DEBUG_KEY) === "1";
  if (chkDebug) {
    chkDebug.checked = savedDebug;
  }
  if (savedDebug && debugPanel) {
    debugPanel.classList.add("show");
  }

  function logDebug(msg) {
    if (!debugBody) return;
    const time = new Date().toLocaleTimeString("zh-TW", { hour12: false });
    debugBody.textContent += `[${time}] ${msg}\n`;
    debugBody.scrollTop = debugBody.scrollHeight;
  }

  if (btnSettings && settingsPanel) {
    btnSettings.addEventListener("click", () => {
      settingsPanel.classList.toggle("show");
    });

    // 點頁面其它地方收起設定面板
    document.addEventListener("click", (e) => {
      if (
        !settingsPanel.contains(e.target) &&
        e.target !== btnSettings
      ) {
        settingsPanel.classList.remove("show");
      }
    });
  }

  if (chkDebug && debugPanel) {
    chkDebug.addEventListener("change", () => {
      const on = chkDebug.checked;
      if (on) {
        debugPanel.classList.add("show");
        localStorage.setItem(DEBUG_KEY, "1");
        logDebug("Debug 面板已開啟");
      } else {
        debugPanel.classList.remove("show");
        localStorage.setItem(DEBUG_KEY, "0");
      }
    });
  }

  if (btnDebugClear && debugBody) {
    btnDebugClear.addEventListener("click", () => {
      debugBody.textContent = "";
    });
  }

  // 監聽 JS 錯誤，寫進 Debug 面板
  window.addEventListener("error", (event) => {
    logDebug("❌ JS Error: " + (event.message || ""));
  });
  window.addEventListener("unhandledrejection", (event) => {
    logDebug("❌ Promise Error: " + (event.reason || ""));
  });

  // ===== 更新提示 Toast =====
  const updateToast = document.getElementById("updateToast");
  function showUpdateToast(msg) {
    if (!updateToast) return;
    updateToast.textContent = msg;
    updateToast.classList.add("show");
    setTimeout(() => {
      updateToast.classList.remove("show");
    }, 3500);
  }

  (function checkVersion() {
    try {
      const VERSION_KEY = "tongue_drum_app_version";
      const oldVer = localStorage.getItem(VERSION_KEY);
      if (oldVer && oldVer !== APP_VERSION) {
        showUpdateToast(`網站已更新到 v${APP_VERSION}（原本 v${oldVer}）`);
      } else if (!oldVer) {
        showUpdateToast(`歡迎使用空靈鼓練習 App v${APP_VERSION}`);
      }
      localStorage.setItem(VERSION_KEY, APP_VERSION);
    } catch (e) {
      console.warn("version check error", e);
    }
  })();

  // ===== 音檔設定 =====
  const audioFiles = {
    "1": "assets/drums/drum_d/drumLong_1.wav",
    "2": "assets/drums/drum_d/drumLong_2.wav",
    "3": "assets/drums/drum_d/drumLong_3.wav",
    "4": "assets/drums/drum_d/drumLong_4.wav",
    "5": "assets/drums/drum_d/drumLong_5.wav",
    "6": "assets/drums/drum_d/drumLong_6.wav",
    "7": "assets/drums/drum_d/drumLong_7.wav",
  };

  const audioMap = {};
  for (let d = 1; d <= 7; d++) {
    const key = String(d);
    const a = new Audio(audioFiles[key]);
    a.preload = "auto";
    audioMap[key] = a;
  }

  function playDegree(degree, padElement) {
    const key = String(degree);
    const audio = audioMap[key];
    if (!audio) return;

    const clone = audio.cloneNode();
    clone.currentTime = 0;
    clone.play();

    if (padElement) {
      padElement.classList.add("active");
      setTimeout(() => padElement.classList.remove("active"), 120);
    } else {
      const pads = document.querySelectorAll(".pad");
      pads.forEach((p) => {
        if (p.dataset.degree === key) {
          p.classList.add("active");
          setTimeout(() => p.classList.remove("active"), 120);
        }
      });
    }
  }

  // ===== 鼓面排列 =====
  const padLayout = [
    { degree: "1", x: 50, y: 50, center: true },
    { degree: "2", x: 50, y: 12 },
    { degree: "3", x: 82, y: 28 },
    { degree: "4", x: 82, y: 68 },
    { degree: "5", x: 50, y: 88 },
    { degree: "6", x: 18, y: 68 },
    { degree: "7", x: 18, y: 28 },
  ];

  function createDrum(containerId, onPadClick) {
    const container = document.getElementById(containerId);
    if (!container) return;
    padLayout.forEach((p) => {
      const pad = document.createElement("div");
      pad.className = "pad" + (p.center ? " center" : "");
      pad.dataset.degree = p.degree;

      const span = document.createElement("span");
      span.textContent = p.degree;
      pad.appendChild(span);

      pad.style.left = p.x + "%";
      pad.style.top = p.y + "%";
      pad.style.transform = "translate(-50%, -50%)";

      pad.addEventListener("click", () => {
        onPadClick(p.degree, pad);
      });

      container.appendChild(pad);
    });
  }

  // Page1：自由演奏鼓面
  createDrum("drum-play", (degree, pad) => {
    playDegree(degree, pad);
  });

  // ===== Page2：聽寫練習 =====
  const earLevelBtns = document.querySelectorAll(".ear-level-btn");
  const btnEarNew = document.getElementById("btnEarNew");
  const btnEarReplay = document.getElementById("btnEarReplay");
  const btnEarClear = document.getElementById("btnEarClear");
  const btnEarCheck = document.getElementById("btnEarCheck");
  const earStatus = document.getElementById("earStatus");
  const earQuestionLenSpan = document.getElementById("earQuestionLen");
  const earAnswerTextSpan = document.getElementById("earAnswerText");

  let earDifficulty = 3;
  let earQuestion = [];
  let earAnswer = [];
  let isPlayingQuestion = false;

  earLevelBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      earLevelBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      earDifficulty = parseInt(btn.dataset.len, 10) || 3;
      if (earQuestion.length === 0) {
        earStatus.textContent = `已選擇題目長度：${earDifficulty} 音。按「出題」開始。`;
      }
      logDebug("變更聽寫難度：" + earDifficulty);
    });
  });

  function updateEarAnswerText() {
    if (earAnswer.length === 0) {
      earAnswerTextSpan.textContent = "（尚未作答）";
    } else {
      earAnswerTextSpan.textContent = earAnswer.join(" - ");
    }
  }

  function setEarQuestion(seq) {
    earQuestion = seq.slice();
    earQuestionLenSpan.textContent = String(earQuestion.length);
    earStatus.textContent = "題目已出，先聽清楚再作答。可以按「再聽一次」。";
    btnEarReplay.disabled = false;
    earAnswer = [];
    updateEarAnswerText();
    logDebug("新題目：" + earQuestion.join(", "));
  }

  function generateQuestion(len) {
    const seq = [];
    for (let i = 0; i < len; i++) {
      const d = String(1 + Math.floor(Math.random() * 7));
      seq.push(d);
    }
    return seq;
  }

  function playQuestionSequence(index = 0) {
    if (!earQuestion || earQuestion.length === 0) return;
    if (index === 0) {
      isPlayingQuestion = true;
      earStatus.textContent = "正在播放題目，請專心聽。";
    }
    if (index >= earQuestion.length) {
      isPlayingQuestion = false;
      earStatus.textContent = "題目播放完畢，請在鼓面或 1～7 按鈕上作答。";
      return;
    }
    const d = earQuestion[index];
    playDegree(d, null);
    setTimeout(() => playQuestionSequence(index + 1), 650);
  }

  function addEarAnswer(digit) {
    if (!digit) return;
    if (isPlayingQuestion) return;
    if (!earQuestion || earQuestion.length === 0) {
      earStatus.textContent = "請先按「出題」。";
      return;
    }
    earAnswer.push(digit);
    updateEarAnswerText();
    playDegree(digit, null);
  }

  if (btnEarNew) {
    btnEarNew.addEventListener("click", () => {
      if (isPlayingQuestion) return;
      const seq = generateQuestion(earDifficulty);
      setEarQuestion(seq);
      playQuestionSequence(0);
    });
  }

  if (btnEarReplay) {
    btnEarReplay.addEventListener("click", () => {
      if (isPlayingQuestion) return;
      if (!earQuestion || earQuestion.length === 0) {
        earStatus.textContent = "目前沒有題目，請先按「出題」。";
        return;
      }
      playQuestionSequence(0);
    });
  }

  if (btnEarClear) {
    btnEarClear.addEventListener("click", () => {
      earAnswer = [];
      updateEarAnswerText();
      if (earQuestion.length > 0) {
        earStatus.textContent = "答案已清除，請重新作答。";
      } else {
        earStatus.textContent = "目前沒有題目，請先按「出題」。";
      }
    });
  }

  if (btnEarCheck) {
    btnEarCheck.addEventListener("click", () => {
      if (!earQuestion || earQuestion.length === 0) {
        earStatus.textContent = "目前沒有題目，請先按「出題」。";
        return;
      }
      if (earAnswer.length === 0) {
        earStatus.textContent = "尚未作答，請在鼓面或 1～7 按鈕上輸入答案。";
        return;
      }
      const correct =
        earAnswer.length === earQuestion.length &&
        earAnswer.every((v, i) => v === earQuestion[i]);
      if (correct) {
        earStatus.textContent = "✅ 答對了！可以換一題或提高難度。";
      } else {
        earStatus.textContent =
          "❌ 再試試看！正確答案是：「" + earQuestion.join(" - ") + "」。";
      }
    });
  }

  // Page2：鼓面（用來回答）
  createDrum("drum-ear", (degree, pad) => {
    addEarAnswer(degree);
  });

  // Page2：1~7 按鈕
  const earButtonsRow = document.getElementById("earButtonsRow");
  if (earButtonsRow) {
    for (let d = 1; d <= 7; d++) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ear-digit-btn";
      btn.textContent = String(d);
      btn.dataset.digit = String(d);
      btn.addEventListener("click", () => {
        addEarAnswer(btn.dataset.digit);
      });
      earButtonsRow.appendChild(btn);
    }
  }

  // 鍵盤 1～7：在演奏頁只發音，在聽寫頁：發音＋作答
  document.addEventListener("keydown", (e) => {
    const key = e.key;
    if (key >= "1" && key <= "7") {
      e.preventDefault();
      if (currentPageId === "page-ear") {
        addEarAnswer(key);
      } else {
        playDegree(key, null);
      }
    }
  });

  logDebug("App 初始化完成，版本：" + APP_VERSION);
</script>
