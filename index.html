<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç©ºéˆé¼“ç·´ç¿’ App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222 0, #111 40%, #000 100%);
      color: #f5f5f5;
      min-height: 100vh;
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: linear-gradient(180deg, #191919 0%, #101010 100%);
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      padding: 14px 12px;
      gap: 10px;
    }
    .sidebar-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .sidebar-sub {
      font-size: 11px;
      color: #aaa;
      margin-top: 2px;
    }
    .mobile-menu-toggle {
      display: none;
      border-radius: 8px;
      border: 1px solid #555;
      background: #181818;
      color: #eee;
      font-size: 14px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .nav-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: #ddd;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s, border-color 0.15s, color 0.15s, transform 0.05s;
    }
    .nav-btn span.icon { font-size: 16px; }
    .nav-btn:hover { background: rgba(255,255,255,0.04); }
    .nav-btn.active {
      background: linear-gradient(90deg, #f3d36f 0%, #cc8a33 60%, #7b4b15 100%);
      color: #1a1a1a;
      border-color: #f9e7af;
      transform: translateX(1px);
    }

    .external-link-box {
      margin-top: 4px;
      padding: 7px 7px;
      border-radius: 8px;
      border: 1px solid #333;
      background: radial-gradient(circle at 0 0, #333 0, #181818 55%, #101010 100%);
      font-size: 12px;
      color: #ddd;
    }
    .external-link-title {
      font-size: 11px;
      color: #aaa;
      margin-bottom: 3px;
    }
    .external-link-btn {
      display: inline-block;
      margin-top: 3px;
      padding: 5px 8px;
      border-radius: 6px;
      border: 1px solid #f5d36f;
      background: linear-gradient(90deg, #f3d36f 0%, #cc8a33 60%, #7b4b15 100%);
      color: #181818;
      font-size: 12px;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .external-link-btn:hover { filter: brightness(1.05); }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: #666;
    }

    /* Main area */
    .main-area {
      flex: 1;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }
    .header-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 1px;
    }
    .header-sub {
      font-size: 13px;
      color: #ccc;
    }

    .settings-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #181818;
      color: #f5f5f5;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
    }
    .settings-btn:hover {
      border-color: #f5d36f;
      color: #f5d36f;
    }

    .settings-panel {
      position: absolute;
      right: 20px;
      top: 58px;
      background: #111;
      border-radius: 10px;
      border: 1px solid #444;
      padding: 10px 12px;
      font-size: 12px;
      min-width: 200px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.7);
      display: none;
      z-index: 1100;
    }
    .settings-panel.show { display: block; }
    .settings-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .settings-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .settings-note {
      font-size: 11px;
      color: #888;
      margin-top: 3px;
    }

    .page {
      display: none;
      flex: 1;
      margin-top: 10px;
    }
    .page.active { display: flex; }

    /* Page: æ¼”å¥å™¨ */
    .page-play { flex-direction: column; align-items: center; gap: 12px; }

    .drum-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    /* é¼“é¢å®¹å™¨ï¼šç”¨ D èª¿é¼“åœ–ç‰‡ç•¶åº• */
    .drum-container {
      position: relative;
      width: min(520px, 80vw);
      height: min(520px, 80vw);
      border-radius: 50%;
      background-image: url("assets/images/drum_d_layout.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
      margin: 16px auto;
    }

    /* é¼“é¢æŒ‰éˆ•ï¼šé€æ˜ï¼Œåªç•™ä¸‹é»æ“Šå€ */
    .pad {
      position: absolute;
      border-radius: 50%;
      border: 2px solid transparent;
      background: transparent;
      cursor: pointer;
      user-select: none;
      transition: transform 0.06s ease-out,
                  box-shadow 0.08s ease-out,
                  border-color 0.08s ease-out,
                  background 0.08s ease-out;
    }

    /* ä¸­å¤®æœ€å¤§åœˆï¼ˆä½éŸ³ 3ï¼‰ */
    .pad-center {
      width: 22%;
      height: 22%;
    }

    /* å…§åœˆå¤§åœ“ */
    .pad-inner {
      width: 18%;
      height: 18%;
    }

    /* å¤–åœˆå°åœ“ */
    .pad-outer {
      width: 14%;
      height: 14%;
    }

    .pad span {
      font-size: 22px;
      font-weight: 600;
      color: #fff;
      opacity: 0;   /* é è¨­éš±å½¢ï¼Œåªç•¶ Debug ç”¨ */
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
      transition: opacity 0.12s;
    }

    .pad:hover span,
    .pad.active span {
      opacity: 0.18;
    }

    /* å…‰æšˆæ•ˆæœ */
 .pad::before {
  content: "";
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #f3d36f 0, #cc8a33 60%, #7b4b15 100%);
  box-shadow: 0 0 12px rgba(0,0,0,0.9);
  opacity: 0;
  transform: scale(0.9);
  transition: opacity 0.12s ease-out, transform 0.12s ease-out;
}

.pad:hover::before {
  opacity: 0.18;          /* ä¸€èˆ¬èˆŒç‰‡ï¼šå¾®äº® */
}

.pad.active::before {
  opacity: 0.85;
  transform: scale(1.02);
}

/* â­ ä¸­å¤®ä½éŸ³ 3ï¼šäº®ä¸€é»ã€ç¨å¾®å¤§ä¸€åœˆï¼Œä½†ä¿ç•™ã€ŒåŠé€æ˜ã€ */
.pad-center:hover::before,
.pad-center.active::before {
  opacity: 0.35;          /* åŠé€æ˜ï¼Œä¸è¦ 1 */
  transform: scale(1.12); /* æ¯”å…¶ä»–èˆŒç‰‡å¤§ä¸€é»é»å°±å¥½ */
}

    .drum-caption {
      font-size: 13px;
      color: #ddd;
      text-align: center;
      line-height: 1.5;
    }

    .kbd {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #666;
      background: #222;
      font-family: monospace;
      font-size: 12px;
      margin: 0 2px;
    }

    .help-panel {
      font-size: 13px;
      color: #ddd;
      text-align: center;
      line-height: 1.6;
      max-width: 520px;
    }

    /* ğŸ™ éŒ„éŸ³é¢æ¿ */
    .record-panel {
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #333;
      background: rgba(0,0,0,0.4);
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      max-width: 520px;
    }
    .record-btn {
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid #666;
      background: #222;
      color: #eee;
      font-size: 12px;
      cursor: pointer;
    }
    .record-btn.primary {
      border-color: #f77;
      background: radial-gradient(circle at 30% 30%, #ff6b6b 0, #b22222 80%);
      color: #fff;
    }
    .record-status {
      font-size: 11px;
      color: #f0e6b2;
      margin-left: auto;
      min-width: 120px;
      text-align: right;
    }

    /* Page: è½å¯«ç·´ç¿’ */
    .page-ear { flex-direction: column; align-items: center; gap: 16px; }
    .ear-controls {
      max-width: 640px;
      width: 100%;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      border: 1px solid #333;
      padding: 10px 12px;
      font-size: 13px;
    }
    .ear-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .ear-label {
      font-size: 13px;
      color: #ddd;
      margin-right: 4px;
    }
    .ear-level-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #666;
      background: #222;
      color: #eee;
      font-size: 12px;
      cursor: pointer;
    }
    .ear-level-btn.active {
      border-color: #f5d36f;
      background: linear-gradient(90deg, #f3d36f 0%, #cc8a33 60%, #7b4b15 100%);
      color: #181818;
    }
    .ear-main-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #666;
      background: #222;
      color: #eee;
      font-size: 13px;
      cursor: pointer;
    }
    .ear-main-btn.primary {
      border-color: #f5d36f;
      background: linear-gradient(90deg, #f3d36f 0%, #cc8a33 60%, #7b4b15 100%);
      color: #181818;
    }
    .ear-main-btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .ear-status {
      font-size: 13px;
      color: #f0e6b2;
      margin-top: 2px;
    }
    .ear-answer {
      font-size: 13px;
      color: #ddd;
      margin-top: 4px;
      line-height: 1.6;
    }
    .ear-answer span {
      font-weight: 500;
      color: #f3d36f;
    }
    .ear-input-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    .ear-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }
    .ear-digit-btn {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid #666;
      background: #222;
      color: #eee;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .ear-digit-btn:hover { border-color: #f5d36f; }
    .ear-hint {
      font-size: 11px;
      color: #aaa;
      text-align: center;
    }

    /* Placeholder pages */
    .placeholder {
      font-size: 14px;
      color: #ccc;
      line-height: 1.7;
      max-width: 520px;
      margin-top: 20px;
    }
    .placeholder-title {
      font-size: 16px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .placeholder-tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #666;
      margin-bottom: 8px;
      color: #aaa;
    }

    .footer {
      font-size: 11px;
      color: #666;
      margin-top: auto;
      margin-bottom: 6px;
      text-align: right;
    }

    /* å³ä¸‹è§’æµ®å‹•é è¦½æŒ‰éˆ• */
    .fab-preview {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #f3d36f 0, #cc8a33 60%, #7b4b15 100%);
      color: #181818;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-decoration: none;
      box-shadow: 0 0 14px rgba(0,0,0,0.8);
      border: 1px solid #f9e7af;
      z-index: 1300;
    }
    .fab-preview:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    /* Debug é¢æ¿ */
    .debug-panel {
      position: fixed;
      left: 8px;
      bottom: 8px;
      width: 270px;
      max-height: 40vh;
      background: #111;
      border-radius: 8px;
      border: 1px solid #444;
      font-size: 11px;
      color: #eee;
      display: none;
      flex-direction: column;
      z-index: 1200;
    }
    .debug-panel.show { display: flex; }
    .debug-header {
      padding: 4px 6px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    .debug-body {
      padding: 4px 6px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .debug-clear-btn {
      border-radius: 6px;
      border: 1px solid #666;
      background:#222;
      color:#eee;
      font-size:10px;
      padding:2px 6px;
      cursor:pointer;
    }

    /* RWD */
    @media (max-width: 900px) {
      .app-shell { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #333;
        padding: 10px 12px;
      }
      .mobile-menu-toggle { display:inline-block; }
      .sidebar-sub { display:none; }
      .sidebar-nav { display:none; margin-top:8px; }
      .sidebar-nav.open { display:flex; flex-direction:column; gap:8px; }
      .main-area { padding: 12px; }
      .help-panel { font-size:12px; padding:0 4px; }
    }
    @media (max-width: 600px) {
      .drum-container {
        width: min(420px, 84vw);
        height: min(420px, 84vw);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header-row">
        <div>
          <div class="sidebar-title">ç©ºéˆé¼“ç·´ç¿’ App</div>
          <div class="sidebar-sub">é¸æ“‡ä½ è¦çš„æ¨¡å¼</div>
        </div>
        <button class="mobile-menu-toggle" type="button">â˜° é¸å–®</button>
      </div>

      <div class="sidebar-nav" id="sidebarNav">
        <button class="nav-btn active" data-page="page-play">
          <span class="icon">ğŸ¥</span> ç©ºéˆé¼“æ¼”å¥å™¨
        </button>
        <button class="nav-btn" data-page="page-ear">
          <span class="icon">ğŸ‘‚</span> è½å¯«ç·´ç¿’
        </button>
        <button class="nav-btn" data-page="page-melody">
          <span class="icon">ğŸµ</span> è‡ªå‹•æ—‹å¾‹
        </button>
        <button class="nav-btn" data-page="page-chord">
          <span class="icon">ğŸ¹</span> å’Œå¼¦ä¼´å¥å™¨
        </button>

        <div class="external-link-box">
          <div class="external-link-title">å…¶ä»–ç·´ç¿’å·¥å…·</div>
          <a class="external-link-btn"
             href="http://127.0.0.1:7860"
             target="_blank">
            ğŸ§ é–‹å•Ÿè½éŸ³è¾¨è­˜ç·´ç¿’ï¼ˆGradioï¼‰
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        v0.7.0 D èª¿ 15 éŸ³ç‰ˆ + è½å¯« + EQ + éŒ„éŸ³ + Debug<br/>éŸ³æª”ï¼šassets/drums/drum_d/
      </div>
    </aside>

    <main class="main-area">
      <div class="header">
        <div class="header-top-row">
          <h1>ç©ºéˆé¼“ç·´ç¿’ App</h1>
          <button class="settings-btn" id="btnSettings" type="button" title="è¨­å®š / Debug">âš™</button>
        </div>
        <div class="header-sub">
          D èª¿ 15 èˆŒç‰‡é¼“é¢æ¼”å¥ + è½å¯«ç·´ç¿’ + æ‰‹æ©Ÿç‰ˆé¸å–® + EQ èª¿æ•´ + éŒ„éŸ³å·¥å…·ã€‚
        </div>
      </div>

      <div class="settings-panel" id="settingsPanel">
        <div class="settings-title">è¨­å®š / å·¥å…·</div>
        <label class="settings-item">
          <input type="checkbox" id="chkDebug" />
          é¡¯ç¤º Debug é¢æ¿
        </label>
        <div class="settings-note">
          åªçµ¦ä½ è‡ªå·±æ¸¬è©¦ç”¨ï¼Œå‹¾é¸å¾Œå·¦ä¸‹è§’æœƒå‡ºç¾ç´€éŒ„è¦–çª—ã€‚
        </div>
      </div>

      <!-- Page: æ¼”å¥å™¨ -->
      <section id="page-play" class="page page-play active">
        <div class="drum-wrapper">
          <div class="drum-container" id="drum-play"></div>
          <div class="drum-caption">
            D èª¿ç©ºéˆé¼“ï¼ˆç°¡åŒ– 1ï½7 éŸ³éšï¼Œå¯¦é«” 15 éŸ³å¸ƒå±€ï¼‰<br/>
            ä¸­å¤®ç‚ºæœ€ä½éŸ³ 3ï¼Œå…§åœˆ / å¤–åœˆå°æ‡‰ä½ å¯¦éš›çš„å…§åœˆå¤§åœˆã€å¤–åœˆå°åœˆè§¸ç™¼ä½ç½®ã€‚
          </div>
        </div>

        <!-- ğŸ™ éŒ„éŸ³é¢æ¿ -->
        <div class="record-panel">
          <button id="btnRecToggle" class="record-btn primary">âº é–‹å§‹éŒ„éŸ³</button>
          <button id="btnRecClear" class="record-btn">ğŸ§¹ æ¸…é™¤ç´€éŒ„</button>
          <button id="btnRecExport" class="record-btn">ğŸ“„ åŒ¯å‡º JSON</button>
          <div id="recStatus" class="record-status">ç›®å‰æœªéŒ„éŸ³</div>
        </div>

        <div class="help-panel">
          ğŸ”Š æ¯å€‹æ•¸å­—ä»£è¡¨ç°¡è­œï¼š1=Dã€2=Eã€3=F#ã€4=Gã€5=Aã€6=Bã€7=C#ï¼ˆåŒä¸€çµ„éŸ³æª”ï¼Œé€éé€Ÿç‡ / æ¿¾æ³¢æ¨¡æ“¬é«˜ä½éŸ³ï¼‰<br/>
          ğŸ–± æ»‘é¼ é»æ“Šé¼“é¢å³å¯ç™¼è²ï¼ˆhover æœƒé¡¯ç¤ºçœŸå¯¦éŸ³åï¼Œä¾‹å¦‚ D4ã€F#3ã€C#5ï¼‰<br/>
          âŒ¨ï¸ éµç›¤æŒ‰ <span class="kbd">1</span>ï½<span class="kbd">7</span> ä¹Ÿå¯ä»¥ç›´æ¥ç™¼éŸ³ï¼ˆä¸åˆ†å…«åº¦ï¼‰<br/>
          âº ã€Œé–‹å§‹éŒ„éŸ³ã€å¾Œï¼Œæ•²æ“Šéƒ½æœƒè¢«è¨˜éŒ„æˆæ™‚é–“åºåˆ—ï¼Œå¯åŒ¯å‡º JSONã€‚
        </div>
      </section>

      <!-- Page: è½å¯«ç·´ç¿’ -->
      <section id="page-ear" class="page page-ear">
        <div class="ear-controls">
          <div class="ear-row">
            <span class="ear-label">ğŸ¯ é›£åº¦ï¼š</span>
            <button class="ear-level-btn" data-len="2">2 éŸ³</button>
            <button class="ear-level-btn active" data-len="3">3 éŸ³</button>
            <button class="ear-level-btn" data-len="4">4 éŸ³</button>
          </div>
          <div class="ear-row">
            <button id="btnEarNew" class="ear-main-btn primary">å‡ºé¡Œ</button>
            <button id="btnEarReplay" class="ear-main-btn" disabled>å†è½ä¸€æ¬¡</button>
            <button id="btnEarClear" class="ear-main-btn">æ¸…é™¤ç­”æ¡ˆ</button>
            <button id="btnEarCheck" class="ear-main-btn">é€å‡ºç­”æ¡ˆ</button>
          </div>
          <div class="ear-status" id="earStatus">æŒ‰ã€Œå‡ºé¡Œã€é–‹å§‹ï¼Œé¡Œç›®æœƒæ’­æ”¾ 2ï½4 å€‹éŸ³ã€‚</div>
          <div class="ear-answer">
            é¡Œç›®éŸ³æ•¸ï¼š<span id="earQuestionLen">-</span><br/>
            ä½ çš„ç­”æ¡ˆï¼š<span id="earAnswerText">ï¼ˆå°šæœªä½œç­”ï¼‰</span>
          </div>
        </div>

        <div class="ear-input-area">
          <div class="drum-container" id="drum-ear"></div>
          <div class="ear-buttons" id="earButtonsRow"></div>
          <div class="ear-hint">
            ğŸ‘‰ å¯ä»¥é»ä¸Šé¢çš„é¼“é¢ã€ä¸‹é¢çš„ <b>1ï½7</b> æŒ‰éˆ•ï¼Œæˆ–ç”¨éµç›¤æŒ‰
            <span class="kbd">1</span>ï½<span class="kbd">7</span> ä½œç­”ï¼ˆåªçœ‹æ•¸å­—ï¼Œä¸åˆ†å…«åº¦ï¼‰ã€‚
          </div>
        </div>
      </section>

      <!-- Page: è‡ªå‹•æ—‹å¾‹ï¼ˆé ç•™ï¼‰ -->
      <section id="page-melody" class="page">
        <div class="placeholder">
          <div class="placeholder-tag">ä¹‹å¾Œè¦åŠ å…¥</div>
          <div class="placeholder-title">ğŸµ è‡ªå‹•æ—‹å¾‹ç”Ÿæˆï¼ˆD èª¿æ‰‹ç¢Ÿé¢¨æ ¼ï¼‰</div>
          <p>ä¹‹å¾Œå¯ä»¥åœ¨é€™è£¡åšè‡ªå‹•æ—‹å¾‹ï¼šç™‚ç™’ / å†¥æƒ³ / é–‹æœ— ç­‰ç­‰é¢¨æ ¼ã€‚</p>
        </div>
      </section>

      <!-- Page: å’Œå¼¦ä¼´å¥å™¨ï¼ˆé ç•™ï¼‰ -->
      <section id="page-chord" class="page">
        <div class="placeholder">
          <div class="placeholder-tag">é€²éšåŠŸèƒ½</div>
          <div class="placeholder-title">ğŸ¹ å’Œå¼¦ä¼´å¥å™¨ï¼ˆChord Progressionï¼‰</div>
          <p>æœªä¾†å¯ä»¥é¸æ“‡ Iâ€“Vâ€“viâ€“IV ç­‰å’Œå¼¦é€²è¡Œï¼Œè®“ä½ åœ¨ä¸Šé¢è‡ªç”±å³èˆˆã€‚</p>
        </div>
      </section>

      <div class="footer">
        v0.7.0ï¼šD èª¿ 15 èˆŒç‰‡é¼“é¢ + EQ èª¿æ•´ + éŒ„éŸ³æ¨¡å¼ + æ‰‹æ©Ÿç‰ˆé¸å–® + è½å¯«ç·´ç¿’ + è¨­å®š / Debug / æµ®å‹•é è¦½éˆ•ã€‚
      </div>
    </main>
  </div>

  <!-- å³ä¸‹è§’é è¦½ FAB -->
  <a href="https://jjkwer333-design.github.io/tongue_drum_app/"
     class="fab-preview"
     target="_blank"
     title="é–‹å•Ÿ GitHub Pages é è¦½">
    ğŸ”—
  </a>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div class="debug-header">
      Debug Logs
      <button class="debug-clear-btn" id="btnDebugClear">æ¸…é™¤</button>
    </div>
    <div class="debug-body" id="debugBody"></div>
  </div>

  <script>
    const APP_VERSION = "0.7.0";

    // --- å·¦å´é¸å–®åˆ‡æ› ---
    const navButtons = document.querySelectorAll(".nav-btn");
    const pages = document.querySelectorAll(".page");
    const sidebarNav = document.getElementById("sidebarNav");
    const mobileToggle = document.querySelector(".mobile-menu-toggle");
    let currentPageId = "page-play";

    function showPage(pageId) {
      currentPageId = pageId;
      pages.forEach(p => p.classList.toggle("active", p.id === pageId));
      navButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.page === pageId));
      if (window.innerWidth <= 900) sidebarNav.classList.remove("open");
      logDebug("åˆ‡æ›é é¢ï¼š" + pageId);
    }

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => showPage(btn.dataset.page));
    });

    if (mobileToggle) {
      mobileToggle.addEventListener("click", () => {
        sidebarNav.classList.toggle("open");
      });
    }

    // --- è¨­å®š / Debug ---
    const btnSettings = document.getElementById("btnSettings");
    const settingsPanel = document.getElementById("settingsPanel");
    const chkDebug = document.getElementById("chkDebug");
    const debugPanel = document.getElementById("debugPanel");
    const debugBody = document.getElementById("debugBody");
    const btnDebugClear = document.getElementById("btnDebugClear");
    const DEBUG_KEY = "tongue_drum_app_debug";

    function logDebug(msg) {
      if (!debugBody) return;
      const time = new Date().toLocaleTimeString("zh-TW", { hour12:false });
      debugBody.textContent += `[${time}] ${msg}\n`;
      debugBody.scrollTop = debugBody.scrollHeight;
    }

    const savedDebug = localStorage.getItem(DEBUG_KEY) === "1";
    if (chkDebug) chkDebug.checked = savedDebug;
    if (savedDebug && debugPanel) debugPanel.classList.add("show");

    if (btnSettings && settingsPanel) {
      btnSettings.addEventListener("click", () => {
        settingsPanel.classList.toggle("show");
      });
      document.addEventListener("click", (e) => {
        if (!settingsPanel.contains(e.target) && e.target !== btnSettings) {
          settingsPanel.classList.remove("show");
        }
      });
    }

    if (chkDebug && debugPanel) {
      chkDebug.addEventListener("change", () => {
        const on = chkDebug.checked;
        if (on) {
          debugPanel.classList.add("show");
          localStorage.setItem(DEBUG_KEY, "1");
          logDebug("Debug é¢æ¿å·²é–‹å•Ÿ");
        } else {
          debugPanel.classList.remove("show");
          localStorage.setItem(DEBUG_KEY, "0");
        }
      });
    }

    if (btnDebugClear && debugBody) {
      btnDebugClear.addEventListener("click", () => debugBody.textContent = "");
    }

    window.addEventListener("error", evt => logDebug("âŒ JS Error: " + (evt.message || "")));
    window.addEventListener("unhandledrejection", evt => logDebug("âŒ Promise Error: " + (evt.reason || "")));

    // --- éŸ³æª” ---
    const audioFiles = {
      "1": "assets/drums/drum_d/drumLong_1.wav",
      "2": "assets/drums/drum_d/drumLong_2.wav",
      "3": "assets/drums/drum_d/drumLong_3.wav",
      "4": "assets/drums/drum_d/drumLong_4.wav",
      "5": "assets/drums/drum_d/drumLong_5.wav",
      "6": "assets/drums/drum_d/drumLong_6.wav",
      "7": "assets/drums/drum_d/drumLong_7.wav"
    };
    const audioMap = {};
    for (let d = 1; d <= 7; d++) {
      const key = String(d);
      const a = new Audio(audioFiles[key]);
      a.preload = "auto";
      audioMap[key] = a;
    }

    // --- Web Audioï¼šEQ / playbackRate è¨­å®š ---
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) {
          audioCtx = new Ctx();
        }
      }
      return audioCtx;
    }

    // å°‡ degree + octaveLabel è½‰æˆ MIDI / çœŸå¯¦éŸ³åï¼ˆåªæ˜¯é¡¯ç¤ºï¼Œä¸å½±éŸ¿å¯¦éš›é »ç‡ï¼‰
    const DEGREE_OFFSET = { "1":0, "2":2, "3":4, "4":5, "5":7, "6":9, "7":11 };
    function degreeToPitchName(degree, octaveLabel) {
      // å‡è¨­ï¼šä¸­éŸ³ï¼šD4 èµ·ï¼ˆ1=D4ï¼‰ï¼Œä½éŸ³å°‘ä¸€å€‹å…«åº¦ï¼Œé«˜éŸ³å¤šä¸€å€‹æˆ–å…©å€‹å…«åº¦
      let baseOctave;
      switch (octaveLabel) {
        case "low":   baseOctave = 3; break;  // D3ï½
        case "high1": baseOctave = 4; break;  // D4ï½
        case "high2": baseOctave = 5; break;  // D5ï½
        default:      baseOctave = 4; break;  // å…¶ä»–ç•¶ä¸­éŸ³
      }
      // 1=Dã€2=Eã€3=F#ã€4=Gã€5=Aã€6=Bã€7=C#
      const semitoneOffset = DEGREE_OFFSET[degree] ?? 0;
      const baseMidi = 62; // D4 = 62
      const octaveDiff = baseOctave - 4;
      const midi = baseMidi + semitoneOffset + octaveDiff * 12;

      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const pitchClass = names[midi % 12];
      const octave = Math.floor(midi / 12) - 1;
      return pitchClass + octave;
    }

    // --- éŒ„éŸ³ç‹€æ…‹ ---
    let isRecording = false;
    let recordStartTime = 0;
    let recordedEvents = [];

    const btnRecToggle = document.getElementById("btnRecToggle");
    const btnRecClear = document.getElementById("btnRecClear");
    const btnRecExport = document.getElementById("btnRecExport");
    const recStatus = document.getElementById("recStatus");

    if (btnRecToggle && recStatus) {
      btnRecToggle.addEventListener("click", () => {
        if (!isRecording) {
          isRecording = true;
          recordStartTime = performance.now();
          recordedEvents = [];
          btnRecToggle.textContent = "â¹ åœæ­¢éŒ„éŸ³";
          recStatus.textContent = "éŒ„éŸ³ä¸­â€¦";
          logDebug("é–‹å§‹éŒ„éŸ³");
        } else {
          isRecording = false;
          btnRecToggle.textContent = "âº é–‹å§‹éŒ„éŸ³";
          recStatus.textContent = `å·²éŒ„è£½ ${recordedEvents.length} ç­†äº‹ä»¶`;
          logDebug("åœæ­¢éŒ„éŸ³ï¼Œå…± " + recordedEvents.length + " ç­†");
        }
      });
    }

    if (btnRecClear && recStatus) {
      btnRecClear.addEventListener("click", () => {
        recordedEvents = [];
        recStatus.textContent = "ç´€éŒ„å·²æ¸…é™¤";
        logDebug("æ¸…é™¤éŒ„éŸ³ç´€éŒ„");
      });
    }

    if (btnRecExport) {
      btnRecExport.addEventListener("click", () => {
        if (!recordedEvents.length) {
          alert("ç›®å‰æ²’æœ‰éŒ„éŸ³ç´€éŒ„ã€‚");
          return;
        }
        const json = JSON.stringify(recordedEvents, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "drum_recording.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logDebug("å·²åŒ¯å‡ºéŒ„éŸ³ JSONï¼Œå…± " + recordedEvents.length + " ç­†");
      });
    }

    // --- æ’­æ”¾å‡½å¼ï¼ˆå¸¶ EQ / playbackRate / éŒ„éŸ³ï¼‰ ---
    function playDegree(degree, padElement, octaveLabel) {
      const key = String(degree);
      const baseAudio = audioMap[key];
      if (!baseAudio) return;

      const ctx = getAudioCtx();
      const clone = baseAudio.cloneNode();
      clone.currentTime = 0;

      // é è¨­ octaveLabel å¦‚æœæ²’çµ¦ï¼Œç•¶ä½œä¸­éŸ³ï¼ˆhigh1ï¼‰
      const oct = octaveLabel || "high1";

      // ç°¡å–®ç”¨ playbackRate æ¨¡æ“¬é«˜ä½éŸ³ï¼šä½éŸ³ç¨æ…¢ï¼Œé«˜éŸ³ç¨å¿«
      let rate = 1.0;
      if (oct === "low")      rate = 0.80;
      else if (oct === "high1") rate = 1.05;
      else if (oct === "high2") rate = 1.18;
      clone.playbackRate = rate;

      if (ctx) {
        ctx.resume && ctx.resume();

        const source = ctx.createMediaElementSource(clone);
        const filter = ctx.createBiquadFilter();
        const gainNode = ctx.createGain();

        // ç°¡å–® EQï¼šä½éŸ³ cutoff ä½ä¸€é»ï¼Œé«˜éŸ³é«˜ä¸€é»ï¼Œä½†éƒ½ç¨å¾®å‰Šæ‰å°–éŠ³é«˜é »
        if (oct === "low") {
          filter.type = "lowpass";
          filter.frequency.value = 1800;  // ä½éŸ³åæš–
          gainNode.gain.value = 1.05;
        } else if (oct === "high2") {
          filter.type = "lowpass";
          filter.frequency.value = 3500;  // é«˜éŸ³ï¼Œä½†ä¸è¦å¤ªå°–
          gainNode.gain.value = 0.95;
        } else { // high1 / å…¶ä»–
          filter.type = "lowpass";
          filter.frequency.value = 2800;
          gainNode.gain.value = 1.0;
        }

        source.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(ctx.destination);

        clone.play();
      } else {
        // æ²’æœ‰ Web Audioï¼ˆå¾ˆèˆŠçš„ç€è¦½å™¨ï¼‰å°±ç›´æ¥æ’­æ”¾
        clone.play();
      }

      // pad è¦–è¦ºæ•ˆæœ
      if (padElement) {
        padElement.classList.add("active");
        setTimeout(() => padElement.classList.remove("active"), 120);
      } else {
        const pads = document.querySelectorAll(".pad");
        pads.forEach((p) => {
          if (p.dataset.degree === key) {
            p.classList.add("active");
            setTimeout(() => p.classList.remove("active"), 120);
          }
        });
      }

      // éŒ„éŸ³ç´€éŒ„
      if (isRecording) {
        const now = performance.now();
        const t = (now - recordStartTime) / 1000.0;
        recordedEvents.push({
          time: Number(t.toFixed(3)),
          degree: key,
          octave: oct
        });
      }
    }

    // ===== é¼“é¢é»æ“Šå€ï¼šD èª¿ 15 èˆŒç‰‡å¸ƒå±€ =====
    // x, y ç‚ºé¼“é¢ä¸Šçš„ç™¾åˆ†æ¯”åº§æ¨™ï¼ˆ0~100ï¼‰ï¼Œä»¥æ•´å¼µåœ–ç‰‡å·¦ä¸Šè§’ç‚º (0,0)ã€‚
    const padLayout = [
      // ä¸­å¤®ï¼šæœ€ä½éŸ³ 3ï¼ˆå–®ç¨ä¸€å¡Šï¼‰
      { id: "3_low_center", degree: "3", octave: "low",  ring: "center", x: 50.0, y: 42 },

      // å…§åœˆï¼šå¤§åœˆ â€”â€” é«˜éŸ³1 åº¦ / ä½éŸ³
      { id: "1_high1_10", degree: "1", octave: "high1", ring: "inner", x: 77,   y: 41 },
      { id: "2_high1_57", degree: "2", octave: "high1", ring: "inner", x: 36.5, y: 21.2 },
      { id: "3_high1_3",  degree: "3", octave: "high1", ring: "inner", x: 62.0, y: 22 },

      { id: "4_low_30",   degree: "4", octave: "low",   ring: "inner", x: 50.0, y: 79.1 },
      { id: "5_low_35",   degree: "5", octave: "low",   ring: "inner", x: 27,   y: 64.6 },
      { id: "6_low_20",   degree: "6", octave: "low",   ring: "inner", x: 74.5, y: 64.6 },
      { id: "7_low_50",   degree: "7", octave: "low",   ring: "inner", x: 22,   y: 42 },

      // å¤–åœˆï¼š7 é»ï¼ˆè—é»ï¼‰â€”â€” åº§æ¨™ä¾ä½ ä¹‹å‰æ ¡æ­£
      { id: "3_high2_top",   degree: "3", octave: "high2", ring: "outer", x: 49.0, y:  8.2 }, // æ­£ä¸Šæ–¹ 3
      { id: "1_high2_tr",    degree: "1", octave: "high2", ring: "outer", x: 78.6, y: 22.8 }, // å³ä¸Š 1
      { id: "6_high2_right", degree: "6", octave: "high2", ring: "outer", x: 88.0, y: 53.9 }, // å³é‚Š 6

      { id: "4_high1_br",    degree: "4", octave: "high1", ring: "outer", x: 66.8, y: 80.6 }, // å³ä¸‹ 4
      { id: "5_high1_bl",    degree: "5", octave: "high1", ring: "outer", x: 33.0, y: 82.5 }, // å·¦ä¸‹ 5
      { id: "7_high1_left",  degree: "7", octave: "high1", ring: "outer", x: 11.3, y: 54.4 }, // å·¦é‚Š 7
      { id: "2_high1_tl",    degree: "2", octave: "high1", ring: "outer", x: 20.6, y: 23.2 }  // å·¦ä¸Š 2
    ];

    function createDrum(containerId, onPadClick) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = "";

      padLayout.forEach((p) => {
        const pad = document.createElement("div");
        pad.classList.add("pad");
        if (p.ring === "center") pad.classList.add("pad-center");
        else if (p.ring === "inner") pad.classList.add("pad-inner");
        else if (p.ring === "outer") pad.classList.add("pad-outer");

        pad.dataset.id = p.id;
        pad.dataset.degree = p.degree;
        pad.dataset.octave = p.octave;

        // è¨ˆç®—çœŸå¯¦éŸ³åï¼Œæ”¾åœ¨ titleï¼ˆhover æ™‚æœƒé¡¯ç¤ºï¼‰
        const pitchName = degreeToPitchName(p.degree, p.octave);
        pad.dataset.pitchName = pitchName;
        pad.title = `${pitchName}ï¼ˆç°¡è­œ ${p.degree}ï¼‰`;

        const span = document.createElement("span");
        span.textContent = p.degree;   // ä¸­é–“éš±ç´„çœ‹åˆ°ç°¡è­œæ•¸å­—
        pad.appendChild(span);

        pad.style.left = p.x + "%";
        pad.style.top  = p.y + "%";
        pad.style.transform = "translate(-50%, -50%)";

        pad.addEventListener("click", () => onPadClick(p.degree, p.octave, pad));
        container.appendChild(pad);
      });
    }

    // --- è½å¯«ç·´ç¿’ ---
    const earLevelBtns = document.querySelectorAll(".ear-level-btn");
    const btnEarNew = document.getElementById("btnEarNew");
    const btnEarReplay = document.getElementById("btnEarReplay");
    const btnEarClear = document.getElementById("btnEarClear");
    const btnEarCheck = document.getElementById("btnEarCheck");
    const earStatus = document.getElementById("earStatus");
    const earQuestionLenSpan = document.getElementById("earQuestionLen");
    const earAnswerTextSpan = document.getElementById("earAnswerText");

    let earDifficulty = 3;
    let earQuestion = [];
    let earAnswer = [];
    let isPlayingQuestion = false;

    earLevelBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        earLevelBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        earDifficulty = parseInt(btn.dataset.len, 10) || 3;
        if (earQuestion.length === 0) {
          earStatus.textContent = `å·²é¸æ“‡é¡Œç›®é•·åº¦ï¼š${earDifficulty} éŸ³ã€‚æŒ‰ã€Œå‡ºé¡Œã€é–‹å§‹ã€‚`;
        }
        logDebug("è®Šæ›´è½å¯«é›£åº¦ï¼š" + earDifficulty);
      });
    });

    function updateEarAnswerText() {
      if (earAnswer.length === 0) {
        earAnswerTextSpan.textContent = "ï¼ˆå°šæœªä½œç­”ï¼‰";
      } else {
        earAnswerTextSpan.textContent = earAnswer.join(" - ");
      }
    }

    function setEarQuestion(seq) {
      earQuestion = seq.slice();
      earQuestionLenSpan.textContent = String(earQuestion.length);
      earStatus.textContent = "é¡Œç›®å·²å‡ºï¼Œå…ˆè½æ¸…æ¥šå†ä½œç­”ã€‚å¯ä»¥æŒ‰ã€Œå†è½ä¸€æ¬¡ã€ã€‚";
      btnEarReplay.disabled = false;
      earAnswer = [];
      updateEarAnswerText();
      logDebug("æ–°é¡Œç›®ï¼š" + earQuestion.join(", "));
    }

    function generateQuestion(len) {
      const seq = [];
      for (let i = 0; i < len; i++) {
        const d = String(1 + Math.floor(Math.random() * 7));
        seq.push(d);
      }
      return seq;
    }

    function playQuestionSequence(index = 0) {
      if (!earQuestion || earQuestion.length === 0) return;
      if (index === 0) {
        isPlayingQuestion = true;
        earStatus.textContent = "æ­£åœ¨æ’­æ”¾é¡Œç›®ï¼Œè«‹å°ˆå¿ƒè½ã€‚";
      }
      if (index >= earQuestion.length) {
        isPlayingQuestion = false;
        earStatus.textContent = "é¡Œç›®æ’­æ”¾å®Œç•¢ï¼Œè«‹åœ¨é¼“é¢æˆ– 1ï½7 æŒ‰éˆ•ä¸Šä½œç­”ã€‚";
        return;
      }
      const d = earQuestion[index];
      // è½å¯«é¡Œç›®ç”¨ã€Œä¸­éŸ³ã€çš„éŸ³è‰²
      playDegree(d, null, "high1");
      setTimeout(() => playQuestionSequence(index + 1), 650);
    }

    function addEarAnswer(digit) {
      if (!digit || isPlayingQuestion) return;
      if (!earQuestion || earQuestion.length === 0) {
        earStatus.textContent = "è«‹å…ˆæŒ‰ã€Œå‡ºé¡Œã€ã€‚";
        return;
      }
      earAnswer.push(digit);
      updateEarAnswerText();
      // ä½œç­”ä¹Ÿç”¨ä¸­éŸ³éŸ³è‰²
      playDegree(digit, null, "high1");
    }

    if (btnEarNew) {
      btnEarNew.addEventListener("click", () => {
        if (isPlayingQuestion) return;
        const seq = generateQuestion(earDifficulty);
        setEarQuestion(seq);
        playQuestionSequence(0);
      });
    }
    if (btnEarReplay) {
      btnEarReplay.addEventListener("click", () => {
        if (isPlayingQuestion) return;
        if (!earQuestion || earQuestion.length === 0) {
          earStatus.textContent = "ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹å…ˆæŒ‰ã€Œå‡ºé¡Œã€ã€‚";
          return;
        }
        playQuestionSequence(0);
      });
    }
    if (btnEarClear) {
      btnEarClear.addEventListener("click", () => {
        earAnswer = [];
        updateEarAnswerText();
        if (earQuestion.length > 0) {
          earStatus.textContent = "ç­”æ¡ˆå·²æ¸…é™¤ï¼Œè«‹é‡æ–°ä½œç­”ã€‚";
        } else {
          earStatus.textContent = "ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹å…ˆæŒ‰ã€Œå‡ºé¡Œã€ã€‚";
        }
      });
    }
    if (btnEarCheck) {
      btnEarCheck.addEventListener("click", () => {
        if (!earQuestion || earQuestion.length === 0) {
          earStatus.textContent = "ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹å…ˆæŒ‰ã€Œå‡ºé¡Œã€ã€‚";
          return;
        }
        if (earAnswer.length === 0) {
          earStatus.textContent = "å°šæœªä½œç­”ï¼Œè«‹åœ¨é¼“é¢æˆ– 1ï½7 æŒ‰éˆ•ä¸Šè¼¸å…¥ç­”æ¡ˆã€‚";
          return;
        }
        const correct =
          earAnswer.length === earQuestion.length &&
          earAnswer.every((v, i) => v === earQuestion[i]);
        earStatus.textContent = correct
          ? "âœ… ç­”å°äº†ï¼å¯ä»¥æ›ä¸€é¡Œæˆ–æé«˜é›£åº¦ã€‚"
          : "âŒ å†è©¦è©¦çœ‹ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼šã€Œ" + earQuestion.join(" - ") + "ã€ã€‚";
      });
    }

    // è½å¯«ä¸‹æ–¹ 1ï½7 æŒ‰éˆ•
    const earButtonsRow = document.getElementById("earButtonsRow");
    if (earButtonsRow) {
      for (let d = 1; d <= 7; d++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ear-digit-btn";
        btn.textContent = String(d);
        btn.dataset.digit = String(d);
        btn.addEventListener("click", () => addEarAnswer(btn.dataset.digit));
        earButtonsRow.appendChild(btn);
      }
    }

    // å»ºç«‹å…©å€‹é¼“é¢
    createDrum("drum-play", (degree, octave, pad) => {
      // æ¼”å¥å™¨ï¼šç…§èˆŒç‰‡å¯¦éš› octave æ’­æ”¾
      playDegree(degree, pad, octave);
    });
    createDrum("drum-ear", (degree, octave, pad) => {
      // è½å¯«é é¢çš„é¼“é¢ï¼šåªè¨˜ä½œç­”ï¼Œæ’­æ”¾ç”¨ä¸­éŸ³
      addEarAnswer(degree);
    });

    // éµç›¤ 1ï½7
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key >= "1" && key <= "7") {
        e.preventDefault();
        if (currentPageId === "page-ear") {
          addEarAnswer(key);
        } else {
          // æ¼”å¥å™¨ç”¨ä¸­éŸ³éŸ³è‰²ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆ high1 / lowï¼‰
          playDegree(key, null, "high1");
        }
      }
    });

    logDebug("App åˆå§‹åŒ–å®Œæˆï¼Œç‰ˆæœ¬ï¼š" + APP_VERSION);
  </script>
</body>
</html>

